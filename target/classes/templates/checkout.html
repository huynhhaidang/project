<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{fragments :: head('Thanh toán')}"></head>
<body>
<div th:replace="~{fragments :: svg-sprite}"></div>
<div th:replace="~{fragments :: preloader}"></div>
<div th:replace="~{fragments :: search-box}"></div>
<div th:replace="~{fragments :: header}"></div>

<section class="py-4 checkout-page">
  <div class="container-lg">
    <div class="d-flex align-items-center justify-content-between flex-wrap mb-4">
      <div>
        <h1 class="mb-1">Thanh toán</h1>
        <p class="text-muted m-0">Xác nhận thông tin giao hàng và chọn hình thức thanh toán</p>
      </div>
      <span class="badge checkout-badge">Bước cuối</span>
    </div>
    <div class="alert" th:if="${errorMessage}" th:text="${errorMessage}"></div>

    <div class="row g-4">
      <div class="col-lg-7">
        <form th:action="@{/checkout}" method="post" th:object="${checkoutRequest}" class="cs-checkout-card">
          <div class="cs-checkout-section">
            <h4>Thông tin giao hàng</h4>
            <div class="cs-checkout-grid">
              <div>
                <label>Họ tên người nhận</label>
                <input type="text" th:field="*{fullName}" class="form-control" required>
                <div class="error" th:if="${#fields.hasErrors('fullName')}" th:errors="*{fullName}"></div>
              </div>
              <div>
                <label>Số điện thoại</label>
                <input type="text" th:field="*{phone}" class="form-control" required>
                <div class="error" th:if="${#fields.hasErrors('phone')}" th:errors="*{phone}"></div>
              </div>
              <div>
                <label>Email</label>
                <input type="email" th:field="*{email}" class="form-control" required>
                <div class="error" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
              </div>
            </div>
            <label class="mt-3">Địa chỉ giao hàng</label>
            <textarea th:field="*{shippingAddress}" rows="3" class="form-control" required></textarea>
            <div class="error" th:if="${#fields.hasErrors('shippingAddress')}" th:errors="*{shippingAddress}"></div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" th:field="*{saveAddress}" id="saveAddress">
              <label class="form-check-label" for="saveAddress">Lưu làm địa chỉ mặc định cho lần sau</label>
            </div>
          </div>

          <div class="cs-checkout-section">
            <h4>Phương thức thanh toán</h4>
            <div class="payment-options">
              <label class="payment-option">
                <input type="radio" name="paymentMethod" value="COD" th:checked="${checkoutRequest.paymentMethod == null || checkoutRequest.paymentMethod == 'COD'}">
                <span>Thanh toán khi nhận hàng (COD)</span>
              </label>
              <label class="payment-option">
                <input type="radio" name="paymentMethod" value="PAYPAL" th:checked="${checkoutRequest.paymentMethod == 'PAYPAL'}">
                <span>Thanh toán bằng PayPal</span>
              </label>
            </div>
          </div>

          <button type="submit" class="btn btn-red mt-3">Xác nhận đặt hàng</button>
        </form>
      </div>

      <div class="col-lg-5">
        <div class="cs-checkout-summary">
          <h4>Đơn hàng của bạn</h4>
          <div class="cs-summary-item" th:each="item : ${items}">
            <div>
              <strong th:text="${item.name}">Tên</strong>
              <span class="text-muted" th:text="'x' + ${item.quantity}">x1</span>
            </div>
            <span th:text="${#numbers.formatDecimal(item.total, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</span>
          </div>
          <div class="summary-divider"></div>
          <div class="cs-summary-total">
            <span>Tổng cộng</span>
            <strong th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')} + ' đ'"></strong>
          </div>
        </div>

        <div class="cs-checkout-summary mt-4" id="paypal-card">
          <h4>Thanh toán nhanh</h4>
          <p class="text-muted">Bạn có thể thanh toán bằng PayPal an toàn, bảo mật.</p>
          <div id="paypal-container-E6X2KX5TTW4EW"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<div th:replace="~{fragments :: footer}"></div>
<div th:replace="~{fragments :: footer-scripts}"></div>
<script src="https://www.paypal.com/sdk/js?client-id=BAAWa1d6ZhdZAQeRKcwj4sk1nyMdb16_idWunHiKUYCiqqi98dOBcQqPCFuZe0mAZL2dIhbvMnbGsM_VW8&components=hosted-buttons&disable-funding=venmo&currency=USD"></script>
<script>
  paypal.HostedButtons({
    hostedButtonId: "E6X2KX5TTW4EW"
  }).render("#paypal-container-E6X2KX5TTW4EW");
</script>
<script>
  const paypalCard = document.getElementById('paypal-card');
  const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');

  function togglePaypal() {
    const selected = document.querySelector('input[name="paymentMethod"]:checked');
    const show = selected && selected.value === 'PAYPAL';
    paypalCard.style.display = show ? 'block' : 'none';
  }

  paymentRadios.forEach(radio => {
    radio.addEventListener('change', togglePaypal);
  });

  togglePaypal();
</script>
</body>
</html>
